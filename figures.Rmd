---
title: "MICB 405 Project 2"
author: "Shannah"
date: "November 17, 2018"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyr)
library(dplyr)
library(pathview)
library(tidyverse)

#If come across negative vector error then you should subset your data (for ex. by proteobar)
```

```{r, read, warning=FALSE, message=FALSE}
ko <- read.table("SaanichInlet_MAGs_ORFs_ko.cleaned.txt") %>% 
  dplyr::rename(orf = V1) %>% 
  dplyr::rename(ko = V2)

rpkm_42 <- read.table("SI042_200m.RPKM.csv", header=FALSE, sep=',') %>% 
  dplyr::rename(orf = V1) %>% 
  dplyr::rename(rpkm = V2)
rpkm_48 <- read.table("SI048_200m.RPKM.csv", header=FALSE, sep=',') %>% 
  dplyr::rename(orf = V1) %>% 
  dplyr::rename(rpkm = V2)
rpkm_73 <- read.table("SI073_200m.RPKM.csv", header=FALSE, sep=',') %>% 
  dplyr::rename(orf = V1) %>% 
  dplyr::rename(rpkm = V2)
rpkm_74 <- read.table("SI074_200m.RPKM.csv", header=FALSE, sep=',') %>% 
  dplyr::rename(orf = V1) %>% 
  dplyr::rename(rpkm = V2)
rpkm_75 <- read.table("SI075_200m.RPKM.csv", header=FALSE, sep=',') %>% 
  dplyr::rename(orf = V1) %>% 
  dplyr::rename(rpkm = V2)
```

Next steps are to join these two tables and some basic transformations to make things a bit easier for `pathview`. 
I've separated, or split, the `orf` value of each row into two new variables: `mag` and `orf_id` corresponding to the character string before and after the underscore in `orf`. This makes it easier to `group_by` MAGs and will be necessary for joining other tables (such as checkM, gtdbtk, etc.) into one dataframe (to rule them all).

The `summarise` code is summing all RPKM values assigned to a KO number for each MAG. This is useful to prevent multiple rows in an eventual matrix for pathview for each copy found. Or accidentally dropping those data if we're not careful. Anyway, we can freely sum RPKM values and that is what is easiest here.

__NOTE__: If your are dealing with RPKM values from multiple cruises (in this example I am only dealing with RPKM from SI042) you will also need to group by a `cruise` variable so these are not summed. Or maybe you want them to be if you are not interested in the time/season/cruise variable. 
If you are interested in visualizing the variability in transcription of a single MAG across the cruises you may also want to `filter` for your MAG of interest then group by `ko` and `cruise`. It all depends on what question you want to answer so be mindful here!

```{r, arrange, warning=FALSE, message=FALSE}
#rpkm_42, rpkm_48, rpkm_73, rpkm_74, rpkm_75

ko_rpkm_42 <- left_join(ko, rpkm_42, by="orf") %>% 
  separate(orf, into=c("mag", "orf_id")) # Split the Prokka ORF names into MAG identifier and ORF
ko_rpkm_48 <- left_join(ko, rpkm_48, by="orf") %>% 
  separate(orf, into=c("mag", "orf_id")) # Split the Prokka ORF names into MAG identifier and ORF
ko_rpkm_73 <- left_join(ko, rpkm_73, by="orf") %>% 
  separate(orf, into=c("mag", "orf_id")) # Split the Prokka ORF names into MAG identifier and ORF
ko_rpkm_74 <- left_join(ko, rpkm_74, by="orf") %>% 
  separate(orf, into=c("mag", "orf_id")) # Split the Prokka ORF names into MAG identifier and ORF
ko_rpkm_75 <- left_join(ko, rpkm_75, by="orf") %>% 
  separate(orf, into=c("mag", "orf_id")) # Split the Prokka ORF names into MAG identifier and ORF
#Merge all
ko_rpkm <- rbind(ko_rpkm_42, ko_rpkm_48, ko_rpkm_73, ko_rpkm_74, ko_rpkm_75)

#number for joining
t_rpkm <- ko_rpkm %>% 
  group_by(mag, ko) %>% 
  summarise(total = sum(rpkm)) 
rpkm_mat <- spread(t_rpkm, key = mag, value = total)
```


First I will analyse the MAGs from checkM output with rpkm abundance values
```{r}

#TODO: include dotted lines to show ranges
#TODO: include the units on each axis (should be %)
#TODO: convert contamination to percentage ?!?!
#TODO: include a None lineage?
#TODO: include range labels

#Probably want to include as many MAGs as possible because we are wanting to fill in a pathway

#Load .tsv file from MetaBAT2 to dat
bin_dat <- read_tsv(file="MetaBAT2_SaanichInlet_200m_min1500_checkM_stdout.tsv", col_names = TRUE)


#Rename Marker lineage so it's one string (makes it easier later)
bin_dat <- bin_dat %>%
  dplyr::rename('Marker_lineage' = 'Marker lineage')

#Add new column with just lineage for point colors
bin_dat <- bin_dat %>%
  dplyr::mutate('lineage' = gsub(".*__(*)", "\\1", Marker_lineage),
                'lineage' = gsub("\\(|\\)", "", lineage),
                'lineage' = gsub("UID.*", "", lineage))


#Plotting Completeness vs Contamination of MAGs at 200m
bin_dat %>%
  ggplot(aes(x=Completeness, y=Contamination, colour=lineage)) +
  geom_point() +
  #added discrete scales ; palette from colorbrewer2 but added extra ("#969696") b/c 13 values
  scale_color_manual(values = c('#a6cee3','#1f78b4',"#b2df8a","#33a02c","#fb9a99",
                                "#e31a1c",'#fdbf6f',"#ff7f00","#cab2d6","#6a3d9a",
                                "#ffff99","#b15928", "#969696")) + 
  geom_vline(xintercept = 50, linetype = "dashed", size = 1, color = "#808080") + 
  geom_vline(xintercept = 70, linetype = "dashed", size = 1, color = "#808080") + #TODO: check what this value is
  geom_vline(xintercept = 90, linetype = "dashed", size = 1, color = "#808080") + #TODO: check what this value is
  geom_hline(yintercept = 50, linetype = "dashed", size = 1, color = "#808080") + #TODO: check what this value is
  geom_hline(yintercept = 70, linetype = "dashed", size = 1, color = "#808080") + #TODO: check what this value is
  geom_hline(yintercept = 90, linetype = "dashed", size = 1, color = "#808080")   #TODO: check what this value is

```

Visualizing the metabolic map with pathview

As an example, we can view the nitrogen metabolism capabilities of our MAGs. To view a different pathway or metabolism the `pathway.id` parameter will need to be changed. Searching for your pathway of interest via the KEGG browser is likely the easiest way to find these IDs.

We can also view the dataframe that is generated by `pathview`. Unfortunately it is not that interesting or useful.

```{r, pathviewing, warning=FALSE, message=FALSE}
# Nitrogen metabolism
n.pv <- pathview(gene.data = rpkm_mat,
                 species = "ko",
                 pathway.id="00920",
                 kegg.dir = "C:\\Users\\Shannah\\OneDrive\\Uni-Year-5\\MICB_405\\Project2")
head(n.pv$plot.data.gene)
```


*Geochemical Gradients


```{r}
# Load raw data
raw_dat <- readr::read_csv("Saanich_Data.csv")

#Clean dat
dat <- 
  raw_dat %>%
  dplyr::select(Cruise, Date, Depth, Temperature,
         WS_O2, WS_NO3, WS_H2S) %>%
  dplyr::filter(!is.na(WS_O2)) %>%
  dplyr::rename(O2_uM=WS_O2, NO3_uM=WS_NO3, H2S_uM=WS_H2S) %>%
  dplyr::mutate(Depth_m=Depth*1000)


#want to create a plot with all 3 variables as x axis and depth as y with shape as type
#can manipulate data frame to do so
dat %>%
  dplyr::select(Depth_m, H2S_uM, NO3_uM, O2_uM) %>%
  gather(key = "Chemical", value = "Concentration", -Depth_m) %>%
  ggplot() +
  geom_point(aes(x=Concentration, y=Depth_m, shape=Chemical, colour=Chemical))
  

```


